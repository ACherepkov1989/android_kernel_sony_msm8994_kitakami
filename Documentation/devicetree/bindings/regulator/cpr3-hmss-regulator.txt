Qualcomm Technologies, Inc. CPR3 Regulator - HMSS Specific Bindings

HMSS CPR3 controllers each support two CPR threads that monitor the voltage of
a pair of application processor (HMSS) clusters that are powered by a shared
regulator supply.  These controllers have a hardware aggregator to combine the
UP/DOWN requests from each CPR thread into a single unified request.  They also
have a hardware channel to use these requests to directly change the supply
voltage at the PMIC via the SPM without software intervention.

HMSS CPR3 controllers also have to take into account the state of the memory
array power mux (APM) when scaling voltage to ensure that memory always receives
a sufficiently high voltage.

Both CPR open-loop voltages and CPR target quotients are stored in hardware
fuses for HMSS CPR3 controllers.

This document describes the HMSS specific CPR3 bindings.

=======================
Required Node Structure
=======================

CPR3 regulators must be described in two levels of devices nodes.  The first
level describes the CPR3 controller.  The second level describes one or more
hardware threads managed by the controller.

All platform independent cpr3-regulator binding guidelines defined in
cpr3-regulator.txt also apply to cpr3-hmss-regulator devices.

====================================
First Level Nodes - CPR3 Controllers
====================================

HMSS specific properties:
- compatible
	Usage:      required
	Value type: <string>
	Definition: should be "qcom,cpr3-msm8996-hmss-regulator"

- qcom,apm-ctrl
	Usage:      required on systems that need APM management
	Value type: <phandle>
	Definition: phandle of memory array power mux (APM) controller device
		    node for the APM that is used by the HMSS VDD supply

- qcom,apm-threshold-voltage
	Usage:      required if qcom,apm-ctrl is specified
	Value type: <u32>
	Definition: Specifies the APM threshold voltage in microvolts.  If the
		    VDD_APCC supply voltage is above this level, then the APM is
		    switched to use VDD_APCC.  If VDD_APCC is below this level,
		    then the APM is switched to use VDD_MX.

- qcom,apm-hysteresis-voltage
	Usage:      optional
	Value type: <u32>
	Definition: Specifies the voltage delta in microvolts between the APM
		    threshold voltage and the highest corner open-loop voltage
		    which may be used as the ceiling for the corner.  If this
		    property is not specified, then a value of 0 is assumed.

- qcom,cpr-up-down-delay-time
	Usage:      required
	Value type: <u32>
	Definition: The time to delay in nanoseconds between consecutive CPR
		    measurements when the last measurement recommended
		    increasing or decreasing the vdd-supply voltage.

- qcom,cpr-hw-closed-loop
	Usage:      optional
	Value type: <empty>
	Definition: Boolean flag which indicates that the HMSS CPR3 controller
		    should operate in hardware closed-loop mode as opposed to
		    software closed-loop mode.

- vdd-limit-supply
	Usage:      required
	Value type: <phandle>
	Definition: phandle of the VDD supply limit regulator which controls the
		    CPR ceiling and floor voltages when operating in hardware
		    closed-loop mode.

- qcom,cpr-clock-throttling
	Usage:      optional
	Value type: <u32>
	Definition: Specifies the power domains for which CPR processor clock
		    throttling should be enabled.  This feature reduces the
		    processor's clock frequency when it is resuming from a low
		    power mode until CPR is able to raise the supply voltage to
		    a final settled value.  The following bits may be set:
			BIT(0) - Power cluster L2 cache
			BIT(1) - Power cluster core 1
			BIT(2) - Power cluster core 0
			BIT(5) - Performance cluster L2 cache
			BIT(6) - Performance cluster core 1
			BIT(7) - Performance cluster core 0

=================================================
Second Level Nodes - CPR Threads for a Controller
=================================================

HMSS specific properties:
- qcom,cpr-fuse-corners
	Usage:      required
	Value type: <u32>
	Definition: Specifies the number of fuse corners.  This value must be 5
		    for HMSS.  These fuse corners are: MinSVS, LowSVS, SVS,
		    Nominal, and Turbo.  Note that a specific fused target
		    quotient is available for the LowSVS corner but a fused
		    open-loop voltage is not available.  The LowSVS open-loop
		    voltage is calculated using linear interpolation between
		    the MinSVS and SVS values.

- qcom,cpr-fuse-combos
	Usage:      required
	Value type: <u32>
	Definition: Specifies the number of fuse combinations being supported by
		    the device.  This value is utilized by several other
		    properties.  Supported values are 1 up to the maximum
		    possible for a given regulator type.  For HMSS the maximum
		    supported value is 1.

- qcom,allow-quotient-interpolation
	Usage:      optional
	Value type: <empty>
	Definition: Boolean flag which indicates that it is acceptable to use
		    interpolated CPR target quotient values.  These values are
		    interpolated between the target quotient Fmax fuse values.

=======
Example
=======

apcc_cpr: cpr3-ctrl@99e8000 {
	compatible = "qcom,cpr3-msm8996-hmss-regulator";
	reg = <0x099e8000 0x4000>, <0x00074000 0x1000>;
	reg-names = "cpr_ctrl", "fuse_base";
	clocks = <&clock_gcc clk_gcc_hmss_rbcpr_clk>;
	clock-names = "core_clk";
	interrupts = <0 48 0>;
	qcom,cpr-ctrl-name = "apcc";

	qcom,cpr-sensor-time = <1000>;
	qcom,cpr-loop-time = <5000000>;
	qcom,cpr-idle-cycles = <15>;
	qcom,cpr-up-down-delay-time = <3000>;
	qcom,cpr-step-quot-init-min = <13>;
	qcom,cpr-step-quot-init-max = <13>;
	qcom,cpr-count-mode = <2>;

	qcom,apm-ctrl = <&apc_apm>;
	qcom,apm-threshold-voltage = <850000>;
	qcom,apm-hysteresis-voltage = <5000>;

	vdd-supply = <&pm8994_s11>;
	vdd-limit-supply = <&pm8994_s11_limit>;

	qcom,cpr-enable;
	qcom,cpr-hw-closed-loop;

	apc0_vreg: regulator@0 {
		qcom,cpr-thread-id = <0>;
		regulator-name = "apc0_corner";
		regulator-min-microvolt = <1>;
		regulator-max-microvolt = <19>;

		qcom,voltage-step = <5000>;

		qcom,cpr-consecutive-up = <0>;
		qcom,cpr-consecutive-down = <2>;
		qcom,cpr-up-threshold = <0>;
		qcom,cpr-down-threshold = <2>;

		qcom,cpr-fuse-corners = <5>;
		qcom,cpr-fuse-combos = <1>;
		qcom,cpr-corners = <19>;

		qcom,cpr-corner-fmax-map = <1 2 6 11 19>;

		qcom,cpr-voltage-ceiling =
			<605000  670000  745000  745000  745000  745000
			 905000  905000  905000  905000  905000 1015000
			1015000 1015000 1015000 1015000 1015000 1015000
			1015000>;
		qcom,cpr-voltage-floor =
			<520000  545000  625000  625000  625000  625000
			 755000  755000  755000  755000  755000  855000
			 855000  855000  855000  855000  855000  855000
			 855000>;

		qcom,corner-frequencies =
			<192000000  268800000  300000000  345600000
			 403200000  480000000  576000000  633600000
			 729600000  806400000  883200000  960000000
			1017600000 1113600000 1190400000 1267200000
			1344000000 1420800000 1459200000>;

		qcom,cpr-ro-scaling-factor =
			<   0    0    0    0 2222 2275 2506 2491
			 2649 2640 2886 2866    0    0    0    0>,
			<   0    0    0    0 2222 2275 2506 2491
			 2649 2640 2886 2866    0    0    0    0>,
			<   0    0    0    0 2222 2275 2506 2491
			 2649 2640 2886 2866    0    0    0    0>,
			<   0    0    0    0 2147 2226 2310 2312
			 2450 2447 2603 2600    0    0    0    0>,
			<   0    0    0    0 1989 2079 2066 2083
			 2193 2201 2283 2296    0    0    0    0>;

		qcom,cpr-open-loop-voltage-fuse-adjustment =
			<0 0 0 0 0>;
		qcom,cpr-closed-loop-voltage-fuse-adjustment =
			<0 0 0 0 0>;

		qcom,allow-voltage-interpolation;
		qcom,allow-quotient-interpolation;
		qcom,cpr-scaled-open-loop-voltage-as-ceiling;
	};

	apc1_vreg: regulator@1 {
		qcom,cpr-thread-id = <1>;
		regulator-name = "apc1_corner";
		regulator-min-microvolt = <1>;
		regulator-max-microvolt = <18>;

		qcom,voltage-step = <5000>;

		qcom,cpr-consecutive-up = <0>;
		qcom,cpr-consecutive-down = <2>;
		qcom,cpr-up-threshold = <0>;
		qcom,cpr-down-threshold = <2>;

		qcom,cpr-fuse-corners = <5>;
		qcom,cpr-fuse-combos = <1>;
		qcom,cpr-corners = <18>;

		qcom,cpr-corner-fmax-map = <1 3 5 11 18>;

		qcom,cpr-voltage-ceiling =
			<605000  670000  670000  745000  745000  905000
			 905000  905000  905000  905000  905000 1015000
			1015000 1015000 1015000 1015000 1015000 1015000>;
		qcom,cpr-voltage-floor =
			<520000  545000  545000  625000  625000  755000
			 755000  755000  755000  755000  755000  855000
			 855000  855000  855000  855000  855000  940000>;

		qcom,corner-frequencies =
			<300000000  345600000  403200000  480000000
			 576000000  633600000  729600000  806400000
			 883200000  960000000 1017600000 1113600000
			1190400000 1267200000 1344000000 1420800000
			1497600000 1593600000>;

		qcom,cpr-ro-scaling-factor =
			<   0    0    0    0 2212 2273 2517 2506
			 2663 2650 2908 2891    0    0    0    0>,
			<   0    0    0    0 2212 2273 2517 2506
			 2663 2650 2908 2891    0    0    0    0>,
			<   0    0    0    0 2212 2273 2517 2506
			 2663 2650 2908 2891    0    0    0    0>,
			<   0    0    0    0 2152 2237 2321 2337
			 2475 2469 2636 2612    0    0    0    0>,
			<   0    0    0    0 2001 2102 2092 2090
			 2203 2210 2297 2297    0    0    0    0>;

		qcom,cpr-open-loop-voltage-fuse-adjustment =
			<0 0 0 5000 0>;
		qcom,cpr-closed-loop-voltage-fuse-adjustment =
			<0 0 0 20000 0>;

		qcom,allow-voltage-interpolation;
		qcom,allow-quotient-interpolation;
		qcom,cpr-scaled-open-loop-voltage-as-ceiling;
	};
};
